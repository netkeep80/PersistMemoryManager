# План разработки PersistMemoryManager

## Текущая фаза: Фаза 2 — Слияние блоков (coalescing)

Подробности по каждой фазе: [phase1.md](phase1.md), [phase2.md](phase2.md)

---

## Общий план

| Фаза | Задача | Статус | Файл |
|------|--------|--------|------|
| 1 | Базовая структура и allocate/deallocate | ✅ Завершена | [phase1.md](phase1.md) |
| 2 | Слияние блоков (coalescing) | ✅ Завершена | [phase2.md](phase2.md) |
| 3 | Персистентность (save/load) | ⏳ Ожидает | — |
| 4 | Тесты и документация | ⏳ Ожидает | — |
| 5 | Оптимизация производительности | ⏳ Ожидает | — |
| 6 | Интеграция с pjson_db | ⏳ Ожидает | — |

---

## Фаза 1: Базовая структура и allocate/deallocate

**Статус:** ✅ Завершена

**Задачи:**
- [x] Определить структуру блока памяти (`Block`)
- [x] Определить структуру менеджера памяти (`MemoryManager`)
- [x] Реализовать `PersistMemoryManager::create()`
- [x] Реализовать `PersistMemoryManager::destroy()`
- [x] Реализовать `PersistMemoryManager::allocate()`
- [x] Реализовать `PersistMemoryManager::deallocate()`
- [x] Реализовать метрики: `total_size()`, `used_size()`, `free_size()`, `fragmentation()`
- [x] Реализовать `validate()` и `dump_stats()`
- [x] Написать юнит-тесты для выделения памяти
- [x] Написать юнит-тесты для освобождения памяти
- [x] Создать пример базового использования

**Результаты:**
- `include/persist_memory_manager.h` — single-header реализация
- `tests/test_allocate.cpp` — тесты выделения памяти
- `tests/test_deallocate.cpp` — тесты освобождения памяти
- `examples/basic_usage.cpp` — базовый пример использования

---

## Фаза 2: Слияние блоков (coalescing)

**Статус:** ✅ Завершена

**Задачи:**
- [x] Реализовать алгоритм `coalesce()` для слияния соседних свободных блоков
- [x] Обновить `deallocate()` для вызова `coalesce()`
- [x] Написать тесты для слияния блоков
- [x] Обновить документацию

**Результаты:**
- `include/persist_memory_manager.h` — добавлен метод `coalesce()`, вызов в `deallocate()`
- `tests/test_coalesce.cpp` — 10 тестов слияния блоков
- `phase2.md` — документация по Фазе 2

---

## Фаза 3: Персистентность (save/load)

**Статус:** ⏳ Ожидает

**Задачи:**
- [ ] Реализовать `save(const char* filename)` для сохранения образа памяти
- [ ] Реализовать `load(const char* filename)` для загрузки образа памяти
- [ ] Реализовать `PersistMemoryManager::load(void* memory, size_t size)` — загрузка из существующего образа
- [ ] Хранение указателей как смещений (offsets) от base_ptr
- [ ] Поддержка разных базовых адресов при загрузке
- [ ] Написать тесты для персистентности
- [ ] Демонстрационный пример: `examples/persistence_demo.cpp`

---

## Фаза 4: Тесты и документация

**Статус:** ⏳ Ожидает

**Задачи:**
- [ ] Достичь покрытия тестами ≥ 90%
- [ ] Стресс-тест: 100,000 аллокаций подряд
- [ ] Чередование allocate/deallocate (1M операций)
- [ ] Написать `tests/test_coalesce.cpp`
- [ ] Написать `tests/test_persistence.cpp`
- [ ] Написать `examples/stress_test.cpp`
- [ ] Написать `docs/api_reference.md`
- [ ] Написать `docs/performance.md`

---

## Фаза 5: Оптимизация производительности

**Статус:** ⏳ Ожидает

**Задачи:**
- [ ] Профилирование текущей реализации
- [ ] Оптимизация поиска в free_bins (бинарный поиск)
- [ ] Уменьшение фрагментации
- [ ] Достичь: allocate 100K блоков ≤ 100 мс
- [ ] Достичь: deallocate 100K блоков ≤ 100 мс
- [ ] Добавить benchmarks в репозиторий

---

## Фаза 6: Интеграция с pjson_db

**Статус:** ⏳ Ожидает

**Задачи:**
- [ ] Изучить API pjson_db
- [ ] Разработать адаптер для использования PersistMemoryManager как аллокатора в pjson_db
- [ ] Написать демонстрационный пример интеграции
- [ ] Провести нагрузочное тестирование совместной работы

---

*Документ создан автоматически на основе технического задания `tz.md`*
